{% extends 'core/base.html' %}

{% block content %}
<div class="pt-24 pb-12 px-4 max-w-7xl mx-auto space-y-8">
    
    <!-- Welcome -->
    <div class="bg-gradient-to-r from-teal-500 to-blue-600 rounded-3xl p-8 md:p-12 text-white relative overflow-hidden shadow-2xl">
        <div class="relative z-10">
            <h1 class="text-3xl md:text-5xl font-bold mb-4">Hello, {{ user_name|title }}!</h1>
            <p class="text-teal-100 text-lg md:w-2/3 mb-6">
                Your latest suggestion: <span class="font-bold bg-white/20 px-2 py-1 rounded">{{ latest_suggestion }}</span>
            </p>
            <div class="flex flex-wrap gap-4">
    <a href="{% url 'add_log' %}" class="px-6 py-3 bg-white text-teal-600 rounded-xl font-bold shadow-lg hover:bg-gray-50 flex items-center gap-2 transition-all">
        <i data-lucide="plus-circle" class="w-5 h-5"></i> Log Activity
    </a>
    
    <!-- NEW AI BUTTON -->
    <a href="{% url 'ai_coach' %}" class="px-6 py-3 bg-purple-500/20 border border-purple-200 text-white backdrop-blur-md rounded-xl font-bold shadow-lg hover:bg-purple-500/30 flex items-center gap-2 transition-all">
        <i data-lucide="sparkles" class="w-5 h-5 text-yellow-300"></i> Ask AI Coach
    </a>
</div>
        </div>
        <i data-lucide="activity" class="absolute -right-10 -bottom-10 text-white/10 w-64 h-64 rotate-12"></i>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Card 1: Avg Health Score -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-teal-500 hover:shadow-xl transition-shadow">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-teal-100 rounded-lg text-teal-600"><i data-lucide="bar-chart-2" class="w-5 h-5"></i></div>
                <h3 class="text-lg font-bold text-gray-700">Avg Health Score</h3>
            </div>
            <div class="flex items-end gap-2">
                <span class="text-4xl font-bold text-gray-900">{{ avg_health_score }}</span>
                <span class="text-gray-400 mb-1">/ 100</span>
            </div>
            <p class="text-xs text-gray-400 mt-2">Calculated from all your logs</p>
        </div>

        <!-- Card 2: Workouts -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-orange-500 hover:shadow-xl transition-shadow">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-orange-100 rounded-lg text-orange-600"><i data-lucide="flame" class="w-5 h-5"></i></div>
                <h3 class="text-lg font-bold text-gray-700">Total Workouts</h3>
            </div>
            <div class="flex items-end gap-2">
                <span class="text-4xl font-bold text-gray-900">{{ total_workouts }}</span>
                <span class="text-gray-400 mb-1">Sessions</span>
            </div>
        </div>

        <!-- Card 3: Sleep -->
        <div class="bg-white p-6 rounded-2xl shadow-lg border-l-4 border-indigo-500 hover:shadow-xl transition-shadow">
            <div class="flex items-center gap-3 mb-2">
                <div class="p-2 bg-indigo-100 rounded-lg text-indigo-600"><i data-lucide="moon" class="w-5 h-5"></i></div>
                <h3 class="text-lg font-bold text-gray-700">Avg Sleep</h3>
            </div>
            <div class="flex items-end gap-2">
                <span class="text-4xl font-bold text-gray-900">{{ avg_sleep }}</span>
                <span class="text-gray-400 mb-1">Hours</span>
            </div>
        </div>
    </div>

    <!-- History Table with Meter -->
    <div class="bg-white rounded-3xl shadow-xl border border-gray-100 overflow-hidden">
        <div class="p-6 border-b border-gray-100 bg-gray-50/50">
            <h3 class="text-xl font-bold text-gray-800">Recent Activity</h3>
        </div>
        <div class="overflow-x-auto">
            <table class="w-full text-left">
                <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                    <tr>
                        <th class="py-4 px-6 font-semibold">Date</th>
                        <th class="py-4 px-6 font-semibold">Activity Type</th>
                        <th class="py-4 px-6 font-semibold">Details</th>
                        <th class="py-4 px-6 font-semibold">Score / Meter</th>
                        <th class="py-4 px-6 font-semibold text-right">Action</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for log in logs %}
                    <tr class="hover:bg-gray-50 transition-colors group">
                        <td class="py-4 px-6 text-gray-700">{{ log.date }}</td>
                        <td class="py-4 px-6">
                            {% if log.log_type == 'EXERCISE' %}
                                <span class="px-3 py-1 rounded-full text-xs font-bold bg-orange-100 text-orange-600">Exercise</span>
                            {% else %}
                                <span class="px-3 py-1 rounded-full text-xs font-bold bg-blue-100 text-blue-600">Food Intake</span>
                            {% endif %}
                        </td>
                        <td class="py-4 px-6 text-sm text-gray-600">
                            {% if log.log_type == 'EXERCISE' %}
                                {{ log.exercise_type }} ({{ log.calories_burned }} kcal)
                            {% else %}
                                Intake: {{ log.calories_intake }} kcal
                            {% endif %}
                        </td>
                        
                        <!-- NEW SEMI-CIRCLE METER COLUMN -->
                        <td class="py-4 px-6">
                            <div class="flex items-center gap-3">
                                <div class="relative w-16 h-10">
                                    <svg viewBox="0 0 100 55" class="w-full h-full overflow-visible">
                                        <!-- Background Arc -->
                                        <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" stroke="#f3f4f6" stroke-width="12" stroke-linecap="round" />
                                        
                                        <!-- Progress Arc (Colored) -->
                                        <!-- FIX: We use a CSS Variable (--score) to pass data cleanly -->
                                        <path d="M 10 50 A 40 40 0 0 1 90 50" fill="none" 
                                              stroke="currentColor" 
                                              stroke-width="12" 
                                              stroke-linecap="round" 
                                              class="transition-all duration-1000 ease-out {% if log.health_score >= 70 %}text-green-500{% elif log.health_score >= 50 %}text-yellow-500{% else %}text-red-500{% endif %}"
                                              stroke-dasharray="126"
                                              style="--score: {{ log.health_score|default:0 }}; stroke-dashoffset: calc(126px - (126px * var(--score) / 100));" />
                                    </svg>
                                    <!-- Score Text Inside -->
                                    <div class="absolute bottom-0 inset-x-0 text-center text-xs font-bold text-gray-700 -mb-1">
                                        {{ log.health_score }}
                                    </div>
                                </div>
                            </div>
                        </td>

                        <td class="py-4 px-6 text-right flex justify-end gap-2">
                            <!-- Edit Button -->
                            <a href="{% url 'edit_log' log.id %}" class="p-2 text-gray-400 hover:text-blue-500 hover:bg-blue-50 rounded-lg transition-all" title="Edit Log">
                                <i data-lucide="pencil" class="w-5 h-5"></i>
                            </a>
                            
                            <!-- Delete Button -->
                            <form action="{% url 'delete_log' log.id %}" method="POST" onsubmit="return confirm('Are you sure you want to delete this log?');" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 rounded-lg transition-all" title="Delete Log">
                                    <i data-lucide="trash-2" class="w-5 h-5"></i>
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="text-center py-8 text-gray-400">No logs found. Start by adding data!</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}